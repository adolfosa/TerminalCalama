<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Código QR con Javascript</title>
    
    <link rel="stylesheet" href="estilos.css" />
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script defer src="app.js"></script>
</head>
<body>
    <div class="contenedor">
        <div class="izquierda">
            <h1>Custodia </h1>
            <form action="" id="formulario" class="formulario">
                <input type="text" id="link" placeholder="Casillero" disabled/>
                <input type="text" id="link2" placeholder="XXXXXXXX-X" />
                <button class="btn1" id="id_btn">Generar QR</button>
            </form>
            <div id="contenedorQR" class="contenedorQR"></div>
            <button class="btn1" onclick="imprimirDiv()">Imprimir</button>
        </div>
        <div class="derecha">
            <h1>Casilleros</h1>
            <div style="width:100%;text-align: center;margin:auto;">
                <label class="label tamtxt">Seleccione el tamaño del bulto </label>
                <select name="talla" id="talla"> 
                <option value=0 class="select-items selectClass">Seleccione</option>
                <option value="Small" class="select-items selectClass">Small</option>
                <option value="Medium" class="select-items selectClass">Medium</option>
                <option value="Large" class="select-items selectClass">Large</option>
                </select>
            </div>
            <div id="matriz"></div>
                <div class="centrar"> 
                <div class="contenedorTabla" style="text-align:center">
                    <h3>Historial</h3>
                    <hr>
                    <table>
                        <thead>
                            <tr>
                                <th>Id</th>
                                <th>Casillero</th>
                                <th>RUT</th>
                                <th>Hora</th>
                                <th>Fecha</th>
                                <th>Tamaño</th>
                                <th>Tipo</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-body">
                            <!-- Filas de la tabla se insertarán aquí -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
       

       
        
    </div>

    <script>
        const matrizContainer = document.getElementById('matriz');
        //const coordenadaDiv = document.getElementById('coordenada');
        const linkInput = document.getElementById('link');
    
        const matrizSize = 7;

        // Función para convertir número a letra (A=0, B=1, ..., Z=25)
        function getLetterFromNumber(num) {
            return String.fromCharCode(65 + num);
        }
    
        // Crear la matriz de botones
        for (let i = 0; i < matrizSize; i++) {
            for (let j = 0; j < matrizSize; j++) {
                const btn = document.createElement('button');
                btn.className = 'btn';
                const letraColumna = getLetterFromNumber(j);
                btn.id = 'lockerbtn'+i+letraColumna;
                btn.textContent = `${i},${letraColumna}`;
                btn.addEventListener('click', () => toggleButton(btn, i, letraColumna));
                matrizContainer.appendChild(btn);
            }
            matrizContainer.appendChild(document.createElement('br'));
        }

        cargarEstado();

        function cargarEstado(){
            // Traemos los datos desde la BDD
            fetch('http://localhost/TerminalCalama/custreload.php')
            .then(response => response.json())
            .then(data => {
                // Creamos un array con cada botón a desactivar
                const estados = data.map(item => item.estado)[0].split("|");
                console.log(estados);
                
                // Por cada botón, excepto si tiene length 0 (vacio)
                estados.forEach(estado => {
                    if(estado.length!==0){
                        const [fila, columna] = estado.split(',');
                        // Buscamos el botón correspondiente
                        const btn = document.querySelectorAll('#lockerbtn'+fila+columna)[0];

                        // Cambiamos sus clases
                        btn.classList.add('disabled');
                        btn.classList.remove('active');
                    }
                });
            })
            .catch(error => {
                console.error('Error al obtener datos: ', error);
            });
        }
    
        // Función para cambiar el estado del botón
        function toggleButton(btn, fila, columna) {
            // Limpiar todos los otros botones al seleccionar uno nuevo
            btns = document.querySelectorAll('.btn');

            btns.forEach(bt => {
                if(bt.classList.contains('active')){
                    bt.classList.remove('active');
                }
            })

            // Si el botón se encuentra desactivado, preguntar por reactivación
            if(btn.classList.contains('disabled')){
                const confirmar = window.confirm('¿Quieres liberar el estado del casillero?');
                if(confirmar){
                    btn.classList.remove('disabled');
                    guardarEstado();
                    //btn.disabled = false;
                }
            }else { //De lo contrario, manejar activación con normalidad
                btn.classList.toggle('active');
                const estado = btn.classList.contains('active') ? 'Ocupado (azul)' : 'Vacío (verde)';
                // coordenadaDiv.textContent = `${fila},${columna}, Estado: ${estado}`;

                // Si el botón está activo, actualiza el input con las coordenadas
                if (btn.classList.contains('active')) {
                    linkInput.value = `${fila},${columna}`;
                } else {
                    linkInput.value = ''; // Si el botón está inactivo, borra el valor del input
                }
            }
        }
        function imprimirDiv() {
    // Crear una ventana emergente temporal
    const ventanaImpresion = window.open('', '_blank');
    
    // Obtener el contenido del div que quieres imprimir
    const contenidoDiv = document.getElementById('contenedorQR').innerHTML;

    //const contadorDiv = document.getElementById('contador').innerHTML;

       // Escribir el contenido en la ventana emergente
    ventanaImpresion.document.write('<html><head><title>Imprimir Div</title></head><body>');
    ventanaImpresion.document.write('<h1>QR Custodia</h1>');
   
    ventanaImpresion.document.write(contenidoDiv);


    
    ventanaImpresion.document.write('</body></html>');

    ventanaImpresion.document.close(); // Cerrar la escritura en la ventana emergente

    setTimeout(imprimir, 50);

    function imprimir(){
    ventanaImpresion.print();
    
}

}

    </script>
</body>
</html>
